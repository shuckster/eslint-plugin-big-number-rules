module.exports = {
  makeTest
}

const { expectingErrors } = require('./common')
const rule = require('../../lib/rules/assignment')

function extractMethods(ops) {
  return Object.entries(ops).reduce((acc, [key, value]) => {
    const method = Array.isArray(value) ? value[1] : value
    return {
      ...acc,
      [key]: method
    }
  }, {})
}

function makeTest(config) {
  const { construct: BigNumber, assignment, supportsBitwise = true } = config

  const methods = assignment

  const {
    ['+=']: plus,
    ['-=']: minus,
    ['/=']: dividedBy,
    ['*=']: multipliedBy,
    ['**=']: exponentiatedBy,
    ['%=']: modulo,
    ['>>=']: shiftedBy,
    ['<<=']: unshiftedBy
  } = extractMethods(methods)

  const bitwiseTests = supportsBitwise
    ? [
        {
          code: `a >>>= 2;`,
          output: `a = ${BigNumber}(a).${shiftedBy}(2);`,
          errors: expectingErrors(1)
        },
        {
          code: `a >>= 2;`,
          output: `a = ${BigNumber}(a).${shiftedBy}(2);`,
          errors: expectingErrors(1)
        },
        {
          code: `a <<= 2;`,
          output: `a = ${BigNumber}(a).${shiftedBy}(-2);`,
          errors: expectingErrors(1)
        },
        {
          code: `a <<= two();`,
          output: `a = ${BigNumber}(a).${unshiftedBy}(-two());`,
          errors: expectingErrors(1)
        }
      ]
    : [
        {
          code: `a >>>= 2;`,
          errors: expectingErrors(1)
        },
        {
          code: `a <<= 2;`,
          errors: expectingErrors(1)
        },
        {
          code: `a <<= two();`,
          errors: expectingErrors(1)
        }
      ]

  const tests = [
    ...bitwiseTests,

    //
    // Arithmetic
    //
    {
      code: `a += 2;`,
      errors: [
        {
          suggestions: [
            {
              desc: `Yes: Change to a = ${BigNumber}(a).${plus}(2)`,
              output: `a = ${BigNumber}(a).${plus}(2);`
            },
            {
              desc: `No: Change to a = ('').concat(a, 2)`,
              output: "a = ('').concat(a, 2);"
            },
            {
              desc: 'No: Change to a = `${a}${2}`',
              output: 'a = `${a}${2}`;'
            }
          ]
        }
      ]
    },
    {
      code: `a -= 2;`,
      output: `a = ${BigNumber}(a).${minus}(2);`,
      errors: expectingErrors(1)
    },
    {
      code: `a /= 2;`,
      output: `a = ${BigNumber}(a).${dividedBy}(2);`,
      errors: expectingErrors(1)
    },
    {
      code: `a *= 2;`,
      output: `a = ${BigNumber}(a).${multipliedBy}(2);`,
      errors: expectingErrors(1)
    },
    {
      code: `a **= 2;`,
      output: `a = ${BigNumber}(a).${exponentiatedBy}(2);`,
      errors: expectingErrors(1)
    },
    {
      code: `a %= 2;`,
      output: `a = ${BigNumber}(a).${modulo}(2);`,
      errors: expectingErrors(1)
    }
  ]

  return {
    name: 'assignment',
    rule,
    validTests: tests.map(test => test.output).filter(Boolean),
    invalidTests: tests
  }
}
